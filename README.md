# SentinelGuardian
<h1> Description </h1>
Welcome to our Azure Sentinel Honeypot Project!

In this repository, we're embarking on an intriguing cybersecurity journey. Our primary goal is to set up Azure Sentinel, a powerful cloud-based Security Information and Event Management (SIEM) solution, and alongside it, a virtual machine in the cloud serving as our honeypot. What makes this honeypot unique is that we intentionally make it super vulnerable to the vast expanse of the internet.
<br />
<br />
What's the catch? We are going to monitor and log a myriad of attacks coming from different IP addresses located in various countries worldwide. These attacks will be tracked and analyzed, and then the real fun begins. We will take this data and visualize it on a map, providing a real-time, geographical representation of the global cyber threat landscape.
<br />
<br />
In this project, our focus narrows down to examining failed Remote Desktop Protocol (RDP) login attempts. These failed RDP logs will be dissected, geolocated, and ultimately placed on a map. The result? A visual representation of where all these attacks are originating from, giving us unique insights into the world of cybersecurity.
<br />
<br />
<h2>High level Overview</h2>
<br />
<br />
<img src="https://i.imgur.com/TWYkzVg.png"/>
<br />
<br />
In this project, we'll guide you through a unique journey into the realm of cybersecurity. Here's a high-level overview of what to expect:
<br />
<br />
<h2>Azure Subscription Setup:</h2>
First and foremost, we'll set up an Azure subscription. The best part? It's free, and you'll receive 16,645 rupees in Azure credits to kickstart your project.
<br />
<br />
Creating the Vulnerable VM: Our next step involves creating a virtual machine (VM) in Azure. But here's the twist: we're going to turn off the external firewall and Windows firewall. This makes the VM highly exposed to the internet, making it an enticing target for potential attackers. We want to see just how quickly they'll discover it!
<br />
<br />
Log Repository in Azure: To capture and store all the intriguing data generated by our exposed VM, we'll establish a Log Analytics workspace in Azure. This repository will ingest logs from the VM, creating a treasure trove of information.
<br />
<br />
Azure Sentinel Setup: Here comes the star of the show, Azure Sentinel! It's Microsoft's Security Information and Event Management (SIEM) solution, and we'll use it to create a dynamic map that visualizes data about various attackers. This map will show their country of origin, IP addresses, and more.
<br />
<br />
PowerShell Magic: As an added layer of insight, we'll use PowerShell. Typically, when a login attempt fails on a Windows machine, you receive limited information about the source. With PowerShell, we'll extract 
the IP addresses from the Windows logs and send them to a third-party API. This API will work its magic, providing us with data like latitude, longitude, state, and province. This information will be sent back to our VM, allowing us to create a custom log enriched with geographic data.
<br />
<br />
In a nutshell, our project is all about creating an enticing honeypot, monitoring incoming attacks, and using Azure Sentinel and PowerShell to gain deeper insights into the global cyber threat landscape.
<br />
<br />
In our inaugural step, we're taking advantage of the Azure free account trial. By signing up for this free account, you'll receive a generous $200 credit that we'll utilize to kickstart our project. This credit enables us to create and configure the essential components of our cybersecurity honeypot experiment.
<br />
<br />
<h2>VM Creation</h2>
Step 2 brings us to the creation of a pivotal component in our cybersecurity experiment. Once you have your Azure subscription all set up, simply head over to portal.azure.com to get started. At the top of the Azure portal, you'll find the 'Virtual Machine' option, which is essentially going to be our 'honeypot.' This virtual machine will be sitting on the internet, fully exposed to the world, ready to pique the curiosity of individuals from various countries who will undoubtedly attempt to log into it once they discover its online presence.
<br />
<br />
Here's what you need to do: Click 'Create' and select 'Virtual Machine' on the left. We'll create a new 'Resource Group,' essentially a logical grouping of resources in Azure that share the same lifespan. Let's call it 'honeypot lab' for clarity. Then, for the name of our virtual machine, let's keep it simple and call it 'honeypot' or 'honeypot-vm.' We'll place everything in 'West US2,' the geographic region where it's going to reside, or, in other words, the data center it will call home.
<br />
<br />
When it comes to setting up a username and password, you can use any combination, but make sure you remember it because we'll need this information to log into the virtual machine later. Leave the rest of the settings as is, check the appropriate boxes, and hit 'Next.'
<br />
<br />
Moving to the 'Networking' section, under 'Network Security Group' (think of it as a firewall), we'll get into some advanced configurations. Here's the catch: We want to 'Allow all' in the firewall, creating a new rule that essentially opens the doors for anything on the public internet. To do this, we'll remove the default rule and craft our custom inbound rule. This rule will permit all traffic to flow into the virtual machine. Set the destination port to '*', and allow any protocol. Set the action to 'Allow,' and assign it a low priority, like 100. You can name it something memorable, like 'danger any in.'
<br />
<br />
This setup is designed to make the virtual machine extremely discoverable. It's intended to respond to any kind of traffic – from TCP pings to ICMP pings – making it enticing and discoverable to anyone. While this approach might not be suitable for a production environment, it serves the purpose of our lab: to facilitate swift discovery and subsequent attacks. Once these configurations are in place, you're ready to go. Click 'Review and Create,' and then 'Create' to initiate the creation of the virtual machine
<br />
<br />
<img src="https://i.imgur.com/jBAhKm9.png"/>
<br />
<br />
<h2>Creation of log analytics workspace</h2>
In our third step, we're diving deeper into the heart of our cybersecurity experiment. Now, it's time to set up a 'Log Analytics Workspace.' This workspace is a pivotal part of our project as it acts as a hub for ingesting logs from our virtual machine. We'll be collecting a range of logs, including Windows event logs, and even creating a custom log enriched with geographic information, all to help us pinpoint the origins of the attackers. The 'Log Analytics Workspace' is the central repository where all these logs will be stored, and it's here that our SIEM (Security Information and Event Management), Azure Sentinel, comes into play. Azure Sentinel will connect to this workspace, allowing us to display the geographic data on the map.
<br />
<br />
So, here's how you do it: Head over to 'Log Analytics' and let's create one. For the resource group, remember the 'honeypot lab' we made in the previous step? Select that. Now, let's name this workspace, I'll go with 'law-honeypot1.' Place it in the 'West US2' region and click 'Review and Create,' then 'Create.'
<br />
<br />
But the story doesn't end there. We're also going to enable the ability to gather logs from the virtual machine into the Log Analytics Workspace. For this, navigate to 'Security Center,' go to 'Environmental Settings' on the left, and select the Log Analytics workspace we just created. Here, we'll activate 'Defender' and deactivate 'SQL Servers' because we won't be working with them. Don't forget to save your settings.
<br />
<br />
<img src="https://i.imgur.com/GgaEffz.png"/>
<br />
<br />
Now, under 'Data Collection,' select 'All Events,' and save your selection. With that done, it's time to connect the Log Analytics Workspace to our virtual machine. Head back to 'Log Analytics,' click on your workspace, and on the left, you'll spot 'Virtual Machine.' This is the VM we created right at the beginning, so click 'Connect' to establish the connection.
<br />
<br />
<img src="https://i.imgur.com/b6IglGE.png"/>
<br />
<br />
<img src="https://i.imgur.com/c49YQwr.png"/>
<br />
<br />
<h2>login to vm with remote desktop</h2>
In this pivotal fourth step, we're venturing inside the heart of the Virtual Machine (VM) that we've strategically set up. Here, we're going to log in via a Remote Desktop connection, gaining access to the VM, and preparing it for its crucial role in our cybersecurity experiment. The process is straightforward. Begin by navigating to your local computer's 'Start' menu. In the search bar, type 'Remote Desktop' and open the application. Here, you'll input the IP address of the virtual machine and click 'Connect.'

For an added layer of security, consider clicking 'More Choices' and selecting 'Use a Different Account' if it's available. You might find that your screen allows you to enter your username and password directly. In that case, input the credentials you initially created when setting up the VM. Once these steps are complete, you'll log into the VM, potentially encountering a certificate warning along the way.
<img src="https://i.imgur.com/RN182Qo.png"/>
<br />
<br />
<h2>Event viewer details</h2>
As we delve further into the inner workings of our virtual machine (VM), it's time to explore the logs that hold crucial information for our cybersecurity project. Within the VM, click on 'Start,' and then navigate to the 'Event Viewer.' Here, we'll be delving into the event logs, which will serve as valuable resources for our upcoming geographical map. Specifically, we're interested in the 'Security' logs under 'Windows Logs.'
<br />
<br />
<img src="https://i.imgur.com/VkKfxjx.png"/>
<br />
<br />
These logs are the record of security events on the virtual machine. Within the plethora of data, our focus is on 'Event ID 4625.' Expanding this event reveals 'Audit Failure,' and these entries represent unsuccessful login attempts to the virtual machine via Remote Desktop Protocol (RDP).
<br />
<br />
<img src="https://i.imgur.com/MzRYaxZ.png"/>
<h3>In the above image we can see the audit failure they used Administrator as id</h3>
<br />
<br />
Our next step is where the magic happens. We will harness the power of an API called 'ipgeolocation,' a tool designed to determine the geographical location of IP addresses in these event logs. This tool is the key to helping us chart the origins of these login attempts on a global map. As we progress, you'll see how these logs and the 'ipgeolocation' API work in harmony to create a vivid representation of the cyber threat landscape.
<br />
<br />
<h2>download powershell script and configuration</h2>
In this critical step, we're about to download a PowerShell script that will play a pivotal role in our cybersecurity experiment(file is in the repository). The script in question is a custom security log exporter, and here's how to set it up. Start by clicking on the provided link, and you'll be prompted to download the script. However, be prepared for a security warning when downloading. Alternatively, you can choose to manually copy the script from line one all the way to its conclusion. Now, open 'PowerShell ISE' on your virtual machine (VM), and select 'New.' Paste the script you just copied into the PowerShell ISE, and save it on the desktop with a name like 'log exporter.
<br />
<br />
<img src="https://i.imgur.com/m4Wwmvh.png"/>
<br />
<br />
The next part is crucial. Before running the script, you'll need to obtain your own API key from the 'ipgeolocation' website, which requires signup. This API key will be utilized in the script to extract geographic data. Now, what does the script do? It's designed to comb through the event log we explored earlier, specifically focusing on 'Event ID 4625' entries denoting failed login attempts. The script captures the IP addresses associated with these failed logins and proceeds to gather their geodata. The result is a new log file. It's worth noting that this log file will be output to a specific location: 'C:\ProgramData.' Be aware that the 'ProgramData' folder is hidden by default, so you may need to access it manually. If no log file is present in this directory, the script will automatically generate a default log file containing sample records, which we'll later use to train the 'Log Analytics Workspace.'
<br />
<br />

Once you've obtained your API key, simply paste it into the script. Running the script will produce purple output in the console, indicating successful execution. It's important to understand that this output will continue to appear every time there's a failed login event in the event viewer. In essence, the script systematically scans the event viewer for 'Event ID 4625' failed logons, retrieves the associated IP addresses, extracts country and geodata through the API, and creates a detailed log file. The initial lines of this log file contain sample data that we'll use to train the 'Log Analytics Workspace
<br />
<br />
<img src="https://i.imgur.com/iGgN32q.png"/>
<br />
<br />
<h2>Create custom log in LAW to bring in our custom log</h2>
<br />
<br />
In this critical step, we're progressing to an essential part of our cybersecurity experiment: creating a custom log within our 'Log Analytics Workspace' (LAW) to efficiently manage and analyze the log data generated by our virtual machine. To get started, navigate to Azure and search for 'Log Analytics.' Access your workspace (in our case, it's the 'honeypot' workspace). Inside the workspace, click on 'Tables,' then 'Create,' and select 'New Custom Log (MMA-Based).
<br />
<br />
<img src="https://i.imgur.com/T3xyuUa.png"/>
<br />
<br />
Now, comes the intriguing part. The first requirement is to add a log file. However, it's important to remember that the log file resides on the virtual machine, not our local host computer. To bridge this gap, we'll need to go back to our VM, access the log file, and copy its contents. You can do this by using 'Windows key + R' to open the 'Run' dialog, and navigate to 'C:\ProgramData.' Once inside, select all the contents ('Ctrl + A') and copy them ('Ctrl + C'). Minimize your virtual machine and open 'Notepad' on your host PC. Paste the log data into Notepad and save it, giving it a name such as 'failed rdp.log.' This file will be used to train 'Log Analytics' on what to look for in the log data.

Now, in the custom log creation process, click 'Browse' to locate the log file you just saved on your desktop. Specify the collection path, which is the location of the log file on the VM, which in our case is 'C:\ProgramData\failed_rdp.log.' Ensure the path is correct for proper log collection. Provide a name for the custom log, like 'failed rdp with geo,' and let it automatically append 'CL' (Custom Log) to the name. After this, create the custom log.
<br />
<br />
<img src="https://i.imgur.com/TjFVzms.png"/>
<br />
<br />
It's worth noting that while the custom log is created immediately, it may take some time for the 'Log Analytics Workspace' and the virtual machine to synchronize and begin bringing in the log data. To check if the log entries are being ingested, you can search for 'failed rdp with geo' in the logs. Your custom log entries might not appear instantly, but when they do, you'll see the results within the 'Log Analytics Workspace.' Additionally, it's a good practice to verify that the Windows Event log ('Security' events) is successfully streaming into the workspace as well, as this forms an essential part of our analysis.
<br />
<br />
<h2></h2>
As we progress deeper into our project, it's time to bring structure to the raw log data we've collected. In the log data, you'll notice lengthy lines that encompass a wealth of information. If we go back to the Azure portal, the 'Raw Data' column within our custom log contains this comprehensive data. To make sense of it and enable meaningful analysis, we need to extract specific fields from this raw data. These fields will help us organize and categorize the data, allowing us to create a more detailed and structured view of the information we've gathered.
<br />
<br />
The fields we aim to extract include critical information like 'latitude,' 'longitude,' 'country,' 'username,' 'timestamp,' 'sourcehost,' 'state,' 'label,' and 'destination.' This step is instrumental in shaping the data for our subsequent analysis and mapping. To perform this extraction, you can copy and paste the provided query into the 'Log Analytics Workspace' (LAW). Navigate to your workspace, which, in our case, is 'law_honeypot1,' and access the 'logs.' This query is designed to create these extracted fields from the 'Raw Data' in your custom log, making the data more accessible and understandable for analysis.
<i><b>
  FAILED_RDP_WITH_GEO_CL 
| extend username = extract(@"username:([^,]+)", 1, RawData),<br />
<br />
         timestamp = extract(@"timestamp:([^,]+)", 1, RawData),<br />
<br />
         latitude = extract(@"latitude:([^,]+)", 1, RawData),<br />
<br />
         longitude = extract(@"longitude:([^,]+)", 1, RawData),<br />
<br />
         sourcehost = extract(@"sourcehost:([^,]+)", 1, RawData),<br />
<br />
         state = extract(@"state:([^,]+)", 1, RawData),<br />
<br />
         label = extract(@"label:([^,]+)", 1, RawData),<br />
<br />
         destination = extract(@"destinationhost:([^,]+)", 1, RawData),<br />
<br />
         country = extract(@"country:([^,]+)", 1, RawData)<br />
<br />
| where destination != "samplehost"<br />
<br />
| where sourcehost != ""<br />
<br />
| summarize event_count=count() by latitude, longitude, sourcehost, label, destination, country<br />
<br />
</b></i>
<br />
<br />
<img src="https://i.imgur.com/ZpHWWzi.png"/>
<br />
<br />
Once executed, this query will not only create these fields but also filter out specific entries where the 'destination' is not 'samplehost' and where the 'sourcehost' is not empty. This data filtering ensures that we are working with relevant information. Additionally, it provides us with an 'event_count' to understand the frequency of different events. This step is a critical piece of our data preparation puzzle, setting the stage for insightful analysis and geographical mapping of the security threats we're monitoring
<br />
<br />
<h2>Setup map in sentinel with Latitude and Longitude (or country)</h2>
In this crucial step, we're setting up the visualization of our data on a map in Azure Sentinel. To achieve this, let's start by opening Azure Sentinel and accessing the workbook. Click on 'Add workbooks,' but we're going to begin from scratch, so remove any default templates and opt for 'Add query.' Now, add the provided query into the query editor:

sql
Copy code<br />
<br />
<b><i>.FAILED_RDP_WITH_GEO_CL<br />
<br />
| extend sourcehost_CF = extract("sourcehost:([^,]+)", 1, RawData),<br />
<br />
         latitude_CF = extract("latitude:([^,]+)", 1, RawData),<br />
<br />
         longitude_CF = extract("longitude:([^,]+)", 1, RawData),<br />
<br />
         country_CF = extract("country:([^,]+)", 1, RawData),<br />
<br />
         label_CF = extract("label:([^,]+)", 1, RawData),<br />
<br />
         destinationhost_CF = extract("destinationhost:([^,]+)", 1, RawData)<br />
<br />
| where destinationhost_CF != "samplehost"<br />
<br />
| where sourcehost_CF != ""<br />
<br />
| summarize event_count = count() by sourcehost_CF, latitude_CF, longitude_CF, country_CF, label_CF, destinationhost_CF</b></i><br />
<br />
This query will help us organize the extracted fields and provide insights into the failed RDP logs' sources.
<br />
<br />
With your query in place, it's time to visualize the data on a map. In the map settings, ensure that you select 'longitude' for the 'X' axis and 'latitude' for the 'Y' axis. Adjust any other settings as needed to refine the visualization. Now, with this configuration, you'll have a dynamic map displaying the geographical origins of the failed RDP log entries.
<br />
<br />
This step is instrumental in achieving the primary goal of our project: to gain a visual understanding of where these security threats are originating from. The map will provide a clear and concise overview of this critical information, allowing us to identify patterns and trends in the attempted RDP logins and enhancing our overall cybersecurity analysis
<h2>Screenshot of Map of failed RDP logs</h2>
<img src="https://i.imgur.com/B6JSpBV.png"/><br />
<br />
<img src="https://i.imgur.com/IkVjz44.png"/><br />
<br />
<img src="https://i.imgur.com/2pNTCU8.png"/><br />
<br />
<img src="https://i.imgur.com/jWxPG6W.png"/><br />
<br />
<img src="https://i.imgur.com/zZgWYZP.png"/><br />
<br />
<img src="https://i.imgur.com/zbyujCi.png"/><br />
<br />
